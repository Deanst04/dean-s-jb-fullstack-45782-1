{% extends "layout.twig" %}

{% block title %}My Tasks - {{ app_name }}{% endblock %}

{% block styles %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
    }

    .page-title {
        font-size: 1.8rem;
        color: #333;
    }

    /* Stats */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
    }

    .stat-value.completed { color: #22c55e; }
    .stat-value.pending { color: #f59e0b; }
    .stat-value.overdue { color: #ef4444; }

    .stat-label {
        font-size: 0.85rem;
        color: #666;
        margin-top: 5px;
    }

    /* Filters */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .filter-select {
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        background: white;
    }

    .filter-tabs {
        display: flex;
        gap: 5px;
    }

    .filter-tab {
        padding: 8px 16px;
        border-radius: 8px;
        text-decoration: none;
        color: #666;
        font-size: 14px;
        transition: all 0.2s;
    }

    .filter-tab:hover {
        background: #e0e0e0;
    }

    .filter-tab.active {
        background: #667eea;
        color: white;
    }

    .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 300px;
    }

    .search-box input {
        flex: 1;
        padding: 8px 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
    }

    /* Task list */
    .tasks-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .task-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background: #fff;
        border: 2px solid #f0f0f0;
        border-radius: 15px;
        gap: 15px;
        transition: all 0.3s ease;
        animation: fadeInUp 0.4s ease-out;
        animation-fill-mode: both;
    }

    .task-item:hover {
        border-color: #667eea;
        transform: translateX(5px);
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
    }

    .task-item.done {
        background: #f8f9fa;
        opacity: 0.7;
    }

    .task-item.done .task-title {
        text-decoration: line-through;
        color: #888;
    }

    .task-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #ddd;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .task-checkbox:hover {
        border-color: #667eea;
    }

    .task-item.done .task-checkbox {
        background: #22c55e;
        border-color: #22c55e;
        color: white;
    }

    .task-image {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        object-fit: cover;
        flex-shrink: 0;
        cursor: pointer;
    }

    .task-content {
        flex: 1;
        min-width: 0;
    }

    .task-title {
        font-size: 16px;
        font-weight: 500;
        color: #333;
        margin-bottom: 5px;
    }

    .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        font-size: 12px;
        color: #888;
    }

    .task-badge {
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 500;
    }

    .badge-priority-high { background: #fee2e2; color: #dc2626; }
    .badge-priority-medium { background: #fef3c7; color: #d97706; }
    .badge-priority-low { background: #dcfce7; color: #16a34a; }

    .badge-due-overdue { background: #fee2e2; color: #dc2626; }
    .badge-due-today { background: #fef3c7; color: #d97706; }
    .badge-due-tomorrow { background: #dbeafe; color: #2563eb; }
    .badge-due-soon { background: #f3e8ff; color: #7c3aed; }

    .badge-category {
        background: #f3f4f6;
        color: #4b5563;
    }

    .task-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }

    .task-created {
        color: #aaa;
        font-size: 11px;
    }

    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #888;
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .empty-state h3 {
        margin-bottom: 10px;
        color: #666;
    }

    /* Import modal */
    .modal-backdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
    }

    .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 20px;
        z-index: 1000;
        min-width: 400px;
        max-width: 90%;
    }

    .modal.active, .modal-backdrop.active {
        display: block;
    }

    /* Image modal */
    .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }

    .image-modal.active {
        display: flex;
    }

    .image-modal img {
        max-width: 90%;
        max-height: 90%;
        border-radius: 10px;
    }

    .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        font-size: 40px;
        color: white;
        cursor: pointer;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        .filters { flex-direction: column; }
        .search-box { max-width: none; }
        .task-item { flex-wrap: wrap; }
        .task-actions { width: 100%; justify-content: flex-end; margin-top: 10px; }
    }

    /* Stagger animation */
    .task-item:nth-child(1) { animation-delay: 0.05s; }
    .task-item:nth-child(2) { animation-delay: 0.1s; }
    .task-item:nth-child(3) { animation-delay: 0.15s; }
    .task-item:nth-child(4) { animation-delay: 0.2s; }
    .task-item:nth-child(5) { animation-delay: 0.25s; }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="page-header">
        <h1 class="page-title">My Tasks</h1>
        <div style="display: flex; gap: 10px;">
            <button onclick="document.getElementById('importModal').classList.add('active'); document.getElementById('modalBackdrop').classList.add('active');" class="btn btn-secondary btn-sm">Import CSV</button>
        </div>
    </div>

    {% if message %}
    <div class="alert alert-{{ messageType }}">{{ message }}</div>
    {% endif %}

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Tasks</div>
        </div>
        <div class="stat-card">
            <div class="stat-value completed">{{ stats.completed }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value pending">{{ stats.pending }}</div>
            <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
            <div class="stat-value overdue">{{ stats.overdue }}</div>
            <div class="stat-label">Overdue</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <div class="filter-tabs">
            <a href="/?filter=all" class="filter-tab {{ filter == 'all' ? 'active' : '' }}">All</a>
            <a href="/?filter=pending" class="filter-tab {{ filter == 'pending' ? 'active' : '' }}">Pending</a>
            <a href="/?filter=completed" class="filter-tab {{ filter == 'completed' ? 'active' : '' }}">Completed</a>
            <a href="/?filter=overdue" class="filter-tab {{ filter == 'overdue' ? 'active' : '' }}">Overdue</a>
            <a href="/?filter=today" class="filter-tab {{ filter == 'today' ? 'active' : '' }}">Due Today</a>
        </div>

        <div class="filter-group">
            <select class="filter-select" onchange="window.location.href='/?filter={{ filter }}&priority='+this.value">
                <option value="">All Priorities</option>
                {% for key, label in priorities %}
                <option value="{{ key }}" {{ currentPriority == key ? 'selected' : '' }}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        {% if categories|length > 0 %}
        <div class="filter-group">
            <select class="filter-select" onchange="window.location.href='/?filter={{ filter }}&category='+this.value">
                <option value="">All Categories</option>
                {% for cat in categories %}
                <option value="{{ cat }}" {{ currentCategory == cat ? 'selected' : '' }}>{{ cat }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <form class="search-box" method="GET">
            <input type="hidden" name="filter" value="{{ filter }}">
            <input type="text" name="search" placeholder="Search tasks..." value="{{ search }}">
            <button type="submit" class="btn btn-primary btn-sm">Search</button>
        </form>
    </div>

    <!-- Task List -->
    <div class="tasks-list">
        {% if tasks|length > 0 %}
            {% for task in tasks %}
            <div class="task-item {{ task.done ? 'done' : '' }}" data-id="{{ task.id }}">
                <div class="task-checkbox" onclick="toggleTask('{{ task.id }}')">
                    {% if task.done %}&#10003;{% endif %}
                </div>

                {% if task.image %}
                <img src="/{{ task.image }}" alt="" class="task-image" onclick="openImageModal('/{{ task.image }}')">
                {% endif %}

                <div class="task-content">
                    <div class="task-title">{{ task.title }}</div>
                    <div class="task-meta">
                        <span class="task-badge badge-priority-{{ task.priority }}">{{ task.priority_label }}</span>
                        {% if task.category %}
                        <span class="task-badge badge-category">{{ task.category }}</span>
                        {% endif %}
                        {% if task.due_date_human %}
                        <span class="task-badge badge-due-{{ task.due_status }}">{{ task.due_date_human }}</span>
                        {% endif %}
                        <span class="task-created">{{ task.created_at_human }}</span>
                    </div>
                </div>

                <div class="task-actions">
                    <a href="/tasks/{{ task.id }}/edit" class="btn btn-secondary btn-sm">Edit</a>
                    <a href="/tasks/{{ task.id }}/delete" class="btn btn-danger btn-sm" onclick="return confirm('Delete this task?')">Delete</a>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">&#128203;</div>
                <h3>No tasks found</h3>
                <p>Create your first task to get started!</p>
                <a href="/tasks/create" class="btn btn-primary" style="margin-top: 20px;">+ Create Task</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Import Modal -->
<div class="modal-backdrop" id="modalBackdrop" onclick="closeImportModal()"></div>
<div class="modal" id="importModal">
    <h3 style="margin-bottom: 20px;">Import Tasks from CSV</h3>
    <form action="/import" method="POST" enctype="multipart/form-data">
        {{ csrf_field()|raw }}
        <div class="form-group">
            <label class="form-label">Select CSV File</label>
            <input type="file" name="csv" accept=".csv" class="form-control" required>
        </div>
        <p style="font-size: 12px; color: #888; margin-bottom: 20px;">
            CSV should have columns: Title, Description, Priority, Category, Due Date, Status
        </p>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" onclick="closeImportModal()" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Import</button>
        </div>
    </form>
</div>

<!-- Image Modal -->
<div class="image-modal" id="imageModal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <img id="modalImage" src="" alt="">
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleTask(id) {
    fetch('/tasks/' + id + '/toggle', {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function closeImportModal() {
    document.getElementById('importModal').classList.remove('active');
    document.getElementById('modalBackdrop').classList.remove('active');
}

function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').classList.add('active');
}

function closeImageModal() {
    document.getElementById('imageModal').classList.remove('active');
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeImportModal();
        closeImageModal();
    }
});
</script>
{% endblock %}
